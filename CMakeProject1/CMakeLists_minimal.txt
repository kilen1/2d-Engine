cmake_minimum_required(VERSION 3.20)
project(2DGameEngine VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Disable features that might cause build issues
option(ENGINE_EDITOR "Build with editor" OFF)
option(ENGINE_TOOLS "Build with tools" OFF)
option(ENGINE_SCRIPTING "Enable scripting support" OFF)  # Disable scripting to avoid Lua issues
option(ENGINE_NETWORKING "Enable networking support" OFF)
option(ENGINE_PHYSICS "Enable physics engine" OFF)
option(ENGINE_AUDIO "Enable audio engine" OFF)
option(ENGINE_UI "Enable UI system" OFF)
option(ENGINE_DEBUG "Build with debug symbols" ON)

# Compiler settings
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

# Find required packages - only essential ones
find_package(PkgConfig REQUIRED)

# If pkg-config finds SDL2
pkg_check_modules(SDL2 REQUIRED sdl2)
pkg_check_modules(SDL2IMAGE REQUIRED SDL2_image)
pkg_check_modules(SDL2TTF REQUIRED SDL2_ttf)

# Include directories
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/include/Core
    ${CMAKE_CURRENT_SOURCE_DIR}/include/Graphics
    ${CMAKE_CURRENT_SOURCE_DIR}/include/Audio
    ${CMAKE_CURRENT_SOURCE_DIR}/include/UI
    ${CMAKE_CURRENT_SOURCE_DIR}/include/Scene
    ${CMAKE_CURRENT_SOURCE_DIR}/include/Editor
    ${CMAKE_CURRENT_SOURCE_DIR}/third_party
    ${CMAKE_CURRENT_SOURCE_DIR}/third_party/imnodes
    ${CMAKE_CURRENT_SOURCE_DIR}/third_party/TextEditor
    ${SDL2_INCLUDE_DIRS}
    ${SDL2IMAGE_INCLUDE_DIRS}
    ${SDL2TTF_INCLUDE_DIRS}
)

# ImGui library
file(GLOB IMGUI_SOURCES 
    third_party/imgui/*.cpp
    third_party/imgui/backends/imgui_impl_sdl2.cpp
    third_party/imgui/backends/imgui_impl_opengl3.cpp
)

add_library(imgui STATIC ${IMGUI_SOURCES})
target_include_directories(imgui PUBLIC
    third_party/imgui
    third_party/imgui/backends
)

# Header-only libraries
add_library(json INTERFACE)
target_include_directories(json INTERFACE third_party/json/include)

add_library(stb INTERFACE)
target_include_directories(stb INTERFACE third_party/stb)

add_library(entt INTERFACE)
target_include_directories(entt INTERFACE third_party/entt/src)

add_library(glm INTERFACE)
target_include_directories(glm INTERFACE third_party/glm)

# Third-party libraries from local sources
add_library(imnodes STATIC
    third_party/imnodes/imnodes.cpp
    third_party/imnodes/imnodes_internal.h
    third_party/imnodes/imnodes.h
)
target_include_directories(imnodes PUBLIC
    third_party/imnodes
)

# Engine source files
file(GLOB_RECURSE CORE_SOURCES "src/Core/*.cpp")
file(GLOB_RECURSE ENGINE_SOURCES "src/*.cpp")
list(APPEND ENGINE_SOURCES ${CORE_SOURCES})

# Remove editor and advanced feature sources if disabled
if(NOT ENGINE_EDITOR)
    list(FILTER ENGINE_SOURCES EXCLUDE REGEX "src/Editor/")
endif()

if(NOT ENGINE_SCRIPTING)
    list(FILTER ENGINE_SOURCES EXCLUDE REGEX "src/Scripting/")
endif()

if(NOT ENGINE_AUDIO)
    list(FILTER ENGINE_SOURCES EXCLUDE REGEX "src/Audio/")
endif()

if(NOT ENGINE_PHYSICS)
    list(FILTER ENGINE_SOURCES EXCLUDE REGEX "src/Physics/")
endif()

# Main executable
add_executable(2DGameEngine
    ${ENGINE_SOURCES}
    main.cpp
)

# Link libraries
target_link_libraries(2DGameEngine
    ${SDL2_LIBRARIES}
    ${SDL2IMAGE_LIBRARIES}
    ${SDL2TTF_LIBRARIES}
    imgui
    imnodes
)

# Compiler definitions
add_definitions(
    -DIMGUI_DISABLE_OBSOLETE_FUNCTIONS
    -DSTB_IMAGE_IMPLEMENTATION
    -DSTB_IMAGE_WRITE_IMPLEMENTATION
    -DLUA_VERSION_MAJOR=5
    -DLUA_VERSION_MINOR=4
    -DGLFW_INCLUDE_NONE
)

if(ENGINE_DEBUG)
    target_compile_definitions(2DGameEngine PRIVATE DEBUG=1)
    set(CMAKE_BUILD_TYPE Debug)
else()
    set(CMAKE_BUILD_TYPE Release)
endif()

# Copy assets after build
file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/bin/assets)
add_custom_command(TARGET 2DGameEngine POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_directory
    ${CMAKE_CURRENT_SOURCE_DIR}/assets
    ${CMAKE_BINARY_DIR}/bin/assets
)